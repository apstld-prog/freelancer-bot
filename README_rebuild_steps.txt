@echo off
title FREELANCER BOT - FULL SCHEMA REBUILD
echo ======================================================
echo üöÄ FREELANCER BOT ‚Äî FULL SCHEMA REBUILD (Windows)
echo ======================================================

REM === 1Ô∏è‚É£ Load DATABASE_URL from environment ===
IF "%DATABASE_URL%"=="" (
    echo ‚ùå ERROR: DATABASE_URL is not set.
    echo ------------------------------------------------------
    echo Please set it manually before running this script.
    echo Example:
    echo    set DATABASE_URL=postgres://user:pass@host:5432/dbname
    echo ------------------------------------------------------
    pause
    exit /b
)

REM === 2Ô∏è‚É£ Confirm rebuild ===
echo This will completely DROP and REBUILD your Render database schema.
echo Press CTRL+C to cancel or any key to continue...
pause >nul

REM === 3Ô∏è‚É£ Drop and recreate schema ===
echo ------------------------------------------------------
echo üßπ Dropping and recreating schema "public" ...
echo ------------------------------------------------------
psql "%DATABASE_URL%" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
IF ERRORLEVEL 1 (
    echo ‚ùå Failed to drop/create schema.
    pause
    exit /b
)

REM === 4Ô∏è‚É£ Apply rebuild_schema.sql ===
echo ------------------------------------------------------
echo üõ†Ô∏è  Applying rebuild_schema.sql ...
echo ------------------------------------------------------
psql "%DATABASE_URL%" -f rebuild_schema.sql
IF ERRORLEVEL 1 (
    echo ‚ùå Schema rebuild failed.
    pause
    exit /b
)

REM === 5Ô∏è‚É£ Done! ===
echo ======================================================
echo ‚úÖ Database schema rebuilt successfully!
echo ======================================================
echo.
echo üîÅ You can now redeploy or restart your Render service.
echo    (or run safe_restart.sh in Render Shell)
echo ======================================================
pause
