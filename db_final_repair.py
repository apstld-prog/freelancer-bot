from sqlalchemy import create_engine, text
import os

print("======================================================")
print("üß© DB FINAL REPAIR ‚Äî Full sync & cleanup of users/admin/keywords")
print("======================================================")

db_url = os.environ.get("DATABASE_URL")
if not db_url:
    print("‚ùå DATABASE_URL not found.")
    exit(1)

engine = create_engine(db_url)

with engine.connect() as conn:

    # 1Ô∏è‚É£ Backup old table
    print("üì¶ Backing up old 'user' table to 'user_backup'...")
    conn.execute(text("DROP TABLE IF EXISTS user_backup;"))
    conn.execute(text("CREATE TABLE IF NOT EXISTS user_backup AS TABLE \"user\";"))
    conn.commit()

    # 2Ô∏è‚É£ Remove bad duplicates from 'users'
    print("üßπ Removing duplicate telegram_id=5254014824 entries (keep one)...")
    conn.execute(text("""
        DELETE FROM users
        WHERE telegram_id = 5254014824
        AND id <> 5254014824;
    """))
    conn.commit()

    # 3Ô∏è‚É£ Ensure admin in users
    print("üë§ Ensuring admin user (5254014824) exists in 'users'...")
    res = conn.execute(text("SELECT id FROM users WHERE id=5254014824;")).fetchone()
    if not res:
        conn.execute(text("""
            INSERT INTO users (id, telegram_id, started_at, is_admin, is_active)
            VALUES (5254014824, 5254014824, NOW() AT TIME ZONE 'UTC', TRUE, TRUE)
            ON CONFLICT (id) DO NOTHING;
        """))
        conn.commit()
        print("‚úÖ Admin inserted.")
    else:
        print("‚úÖ Admin already exists.")

    # 4Ô∏è‚É£ Drop and rebuild foreign key link
    print("üîó Rebuilding keyword.user_id foreign key...")
    conn.execute(text("ALTER TABLE keyword DROP CONSTRAINT IF EXISTS keyword_user_id_fkey;"))
    conn.execute(text("""
        ALTER TABLE keyword
        ADD CONSTRAINT keyword_user_id_fkey
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE;
    """))
    conn.commit()

    # 5Ô∏è‚É£ Clean orphan keywords
    print("üßπ Cleaning orphan keyword rows (no matching users)...")
    conn.execute(text("""
        DELETE FROM keyword WHERE user_id NOT IN (SELECT id FROM users);
    """))
    conn.commit()

    # 6Ô∏è‚É£ Remove old 'user' table
    print("üóë Dropping old 'user' table completely (kept as backup)...")
    conn.execute(text("DROP TABLE IF EXISTS \"user\" CASCADE;"))
    conn.commit()

    # 7Ô∏è‚É£ Verify admin consistency
    print("üîç Verifying admin in users...")
    check = conn.execute(text("""
        SELECT id, telegram_id, is_admin, is_active FROM users WHERE id=5254014824;
    """)).fetchone()
    print(f"‚úÖ Admin record: {check}")

print("üéâ FINAL REPAIR COMPLETE.")
print("üëâ Now run:")
print("   python3 init_keywords.py")
print("   ./diagnostic.sh")
print("======================================================")
