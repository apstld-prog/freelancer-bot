#!/bin/bash
# ======================================================
# üîç FREELANCER BOT EXTENDED DIAGNOSTIC TOOL (v3.0)
# ======================================================

echo "======================================================"
echo "üîç FREELANCER BOT EXTENDED DIAGNOSTIC TOOL (v3.0)"
echo "======================================================"
echo "üìÖ Date: $(date -u)"
echo

# STEP 1 ‚Äî Environment summary
echo "üëâ STEP 1: Environment summary"
echo "------------------------------------------------------"
SERVICE_NAME=${RENDER_SERVICE_NAME:-"freelancer-bot"}
echo "Service: ${SERVICE_NAME}"
python3 --version
echo

# STEP 2 ‚Äî Worker processes
echo "üëâ STEP 2: Worker processes"
echo "------------------------------------------------------"
ps aux | grep "python3 -u workers/" | grep -v grep || echo "‚ö†Ô∏è No worker processes found"
echo

# STEP 3 ‚Äî Feed event stats (last 24h and total)
echo "üëâ STEP 3: Feed event stats (last 24h + total)"
echo "------------------------------------------------------"
psql "$DATABASE_URL" <<'SQL'
\pset format aligned
\pset border 2
\pset linestyle unicode
\pset title 'üìä Jobs fetched per platform (last 24h)'
SELECT platform, COUNT(*) AS jobs_last_24h
FROM job_event
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY platform
ORDER BY jobs_last_24h DESC;

\pset title 'üìà Total jobs stored per platform'
SELECT platform, COUNT(*) AS total_jobs
FROM job_event
GROUP BY platform
ORDER BY total_jobs DESC;
SQL
echo

# STEP 4 ‚Äî Recent events check (freshness within 1h)
echo "üëâ STEP 4: Recent events check (1h freshness)"
echo "------------------------------------------------------"
psql "$DATABASE_URL" -c "
SELECT platform, COUNT(*) AS recent_jobs
FROM job_event
WHERE created_at >= NOW() - INTERVAL '1 hour'
GROUP BY platform;
"
echo

# STEP 5 ‚Äî Memory & uptime snapshot
echo "üëâ STEP 5: Memory & uptime snapshot"
echo "------------------------------------------------------"
uptime
free -h
echo

# STEP 6 ‚Äî Keyword consistency per user
echo "üëâ STEP 6: Keyword consistency per user"
echo "------------------------------------------------------"
psql "$DATABASE_URL" -c "
SELECT user_id, COUNT(*) AS kw_count, STRING_AGG(keyword, ', ' ORDER BY keyword) AS keywords
FROM user_keywords
GROUP BY user_id;
"
echo

# STEP 7 ‚Äî get_user_keywords() verification
echo "üëâ STEP 7: get_user_keywords() verification"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
try:
    from db_keywords import get_user_keywords
    print("‚úÖ get_user_keywords() import OK")
except Exception as e:
    print(f"‚ùå get_user_keywords() failed: {e}")
PYCODE
echo

# STEP 8 ‚Äî Recent worker log tail
echo "üëâ STEP 8: Recent worker log tail"
echo "------------------------------------------------------"
for f in logs/worker_freelancer.log logs/worker_pph.log logs/worker_skywalker.log; do
  if [ -f "$f" ]; then
    echo "--- $f ---"
    tail -n 15 "$f"
    echo
  else
    echo "‚ö†Ô∏è Missing: $f"
  fi
done

echo "‚úÖ Extended diagnostic complete."
echo "======================================================"
