#!/bin/bash
set -e

echo "======================================================"
echo "üîç FREELANCER BOT ADVANCED DIAGNOSTIC TOOL"
echo "======================================================"
echo "üìÖ Date: $(date -u)"
echo

# STEP 1: ENVIRONMENT SUMMARY
echo "üëâ STEP 1: Environment summary"
echo "------------------------------------------------------"
echo "Render Service: ${RENDER_SERVICE_NAME:-freelancer-bot-ns7s}"
echo "Python $(python3 --version 2>/dev/null || echo 'N/A')"
echo "$(node -v 2>/dev/null || echo 'Node N/A')"
echo "Worker intervals: FREELANCER=${FREELANCER_INTERVAL:-N/A}, PPH=${PPH_INTERVAL:-N/A}, GREEK=${GREEK_INTERVAL:-N/A}"
echo "Keyword filter mode: ${KEYWORD_FILTER_MODE:-off}"
echo

# STEP 2: CLEANUP ZOMBIE / DEFUNCT PROCESSES
echo "üëâ STEP 2: Cleanup of zombie/defunct workers"
echo "------------------------------------------------------"
ZOMBIES=$(ps -eo stat,comm | grep 'Z' | grep python || true)
if [ -z "$ZOMBIES" ]; then
  echo "‚úÖ No zombie processes found."
else
  echo "‚ö†Ô∏è Found zombie processes:"
  echo "$ZOMBIES"
  echo "üîß Killing them..."
  pkill -9 -f worker_ || true
  pkill -9 -f uvicorn || true
  echo "‚úÖ Cleanup done."
fi
echo

# STEP 3: ADMIN USER CHECK
echo "üëâ STEP 3: Admin user consistency"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
from db import get_session
from sqlalchemy import text

ADMIN_ID = 5254014824
try:
    with get_session() as s:
        conn = s.connection()
        table = conn.execute(text("""
            SELECT table_name FROM information_schema.tables
            WHERE table_schema='public' AND table_name ILIKE 'user%';
        """)).fetchone()
        if not table:
            print("‚ùå No user table found in DB.")
            exit()
        table = table[0]
        print(f"‚úÖ Found user table: {table}")
        res = conn.execute(text(f"""
            SELECT id, telegram_id FROM "{table}"
            WHERE id=:id OR telegram_id=:id
        """), {"id": ADMIN_ID}).fetchone()
        if res:
            print(f"‚úÖ Admin user exists: {res}")
        else:
            print("‚ö†Ô∏è Admin user not found. Run: python3 init_users.py")
except Exception as e:
    print(f"‚ùå Admin check failed: {e}")
PYCODE
echo

# STEP 4: KEYWORDS CHECK
echo "üëâ STEP 4: Keyword consistency check"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
from db import get_session
from sqlalchemy import text

try:
    with get_session() as s:
        conn = s.connection()
        kwcount = conn.execute(text("SELECT COUNT(*) FROM keyword;")).scalar()
        if kwcount == 0:
            print("‚ö†Ô∏è No keywords found in DB.")
        else:
            print(f"‚úÖ Found {kwcount} total keywords in DB.")
except Exception as e:
    print(f"‚ùå Keyword check failed: {e}")
PYCODE
echo

# STEP 5: PLATFORM FETCH TEST (NO ASYNC)
echo "üëâ STEP 5: Fetch test per platform"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
from platform_freelancer import fetch_freelancer_jobs
from platform_peopleperhour import fetch_pph_jobs
from platform_skywalker import fetch_skywalker_jobs

def safe_run(func, name):
    try:
        results = func(["logo"])
        print(f"‚úÖ {name}: {len(results)} jobs fetched")
    except Exception as e:
        print(f"‚ö†Ô∏è {name} fetch error: {e}")

safe_run(fetch_freelancer_jobs, "Freelancer")
safe_run(fetch_pph_jobs, "PeoplePerHour")
safe_run(fetch_skywalker_jobs, "Skywalker")
PYCODE
echo

# STEP 6: MEMORY & SYSTEM SNAPSHOT
echo "üëâ STEP 6: Memory, uptime and system load"
echo "------------------------------------------------------"
uptime
free -h
echo

echo "‚úÖ Full diagnostic complete."
echo "======================================================"
