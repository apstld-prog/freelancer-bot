#!/bin/bash
set -e

echo "======================================================"
echo "üîç FREELANCER BOT EXTENDED DIAGNOSTIC TOOL"
echo "======================================================"
echo "üìÖ Date: $(date -u)"
echo

# STEP 1: ENVIRONMENT
echo "üëâ STEP 1: Environment summary"
echo "------------------------------------------------------"
echo "Service: ${RENDER_SERVICE_NAME:-freelancer-bot-ns7s}"
python3 --version || echo "Python N/A"
echo

# STEP 2: WORKER PROCESSES
echo "üëâ STEP 2: Worker processes"
echo "------------------------------------------------------"
ps aux | grep worker_ | grep -v grep || echo "‚ö†Ô∏è No worker processes found"
echo

# STEP 3: FEED EVENT STATS
echo "üëâ STEP 3: Feed event stats (last 24h)"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
from db_events import get_platform_stats
try:
    stats = get_platform_stats(24)
    if not stats:
        print("‚ö†Ô∏è No events in last 24h.")
    else:
        for k,v in stats.items():
            print(f"‚úÖ {k}: {v} jobs recorded")
except Exception as e:
    print("‚ùå Feed stats failed:", e)
PYCODE
echo

# STEP 4: FRESHNESS CHECK
echo "üëâ STEP 4: Recent events check (1h freshness)"
echo "------------------------------------------------------"
python3 - <<'PYCODE'
from db import get_session
from sqlalchemy import text
from datetime import datetime, timedelta, timezone
try:
    with get_session() as s:
        ts = datetime.now(timezone.utc) - timedelta(hours=1)
        rows = s.execute(text("SELECT source, COUNT(*) FROM feed_events WHERE ts >= :ts GROUP BY source"), {"ts": ts}).fetchall()
        if not rows:
            print("‚ö†Ô∏è No events in the last hour ‚Äî workers might be idle.")
        else:
            for r in rows:
                print(f"‚úÖ Recent activity: {r[0]} => {r[1]} entries")
except Exception as e:
    print("‚ùå Freshness check failed:", e)
PYCODE
echo

# STEP 5: SYSTEM SNAPSHOT
echo "üëâ STEP 5: Memory & uptime snapshot"
echo "------------------------------------------------------"
uptime
free -h
echo

echo "‚úÖ Extended diagnostic complete."
echo "======================================================"
