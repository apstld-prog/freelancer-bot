#!/bin/bash
# ==========================================================
# üöÄ SAFE RESTART SCRIPT ‚Äî FREELANCER BOT (FINAL RENDER VERSION)
# ==========================================================
# - Restarts all components (server + workers)
# - Keeps logs per run under ./logs/
# - Runs all processes detached (nohup + disown)
# - Health-checks server.py before reporting success
# ==========================================================

set -e
cd "$(dirname "$0")"

LOG_DIR="./logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/restart_$(date +'%Y-%m-%d_%H%M').log"

echo "==========================================================" | tee "$LOG_FILE"
echo "üöÄ SAFE RESTART ‚Äî FREELANCER BOT (Render)" | tee -a "$LOG_FILE"
echo "==========================================================" | tee -a "$LOG_FILE"
echo "$(date)" | tee -a "$LOG_FILE"
echo | tee -a "$LOG_FILE"

echo "üëâ Stopping all running python processes..." | tee -a "$LOG_FILE"
pkill -f "python3" || true
sleep 2
echo "‚úÖ All python processes terminated." | tee -a "$LOG_FILE"

echo | tee -a "$LOG_FILE"
echo "üëâ Starting server.py..." | tee -a "$LOG_FILE"
nohup python3 -u server.py >> "$LOG_FILE" 2>&1 &
disown
sleep 5

echo "üëâ Starting workers..." | tee -a "$LOG_FILE"
nohup python3 -u workers/worker_freelancer.py >> "$LOG_FILE" 2>&1 &
disown
sleep 1
nohup python3 -u workers/worker_pph.py >> "$LOG_FILE" 2>&1 &
disown
sleep 1
nohup python3 -u workers/worker_skywalker.py >> "$LOG_FILE" 2>&1 &
disown
sleep 2

echo | tee -a "$LOG_FILE"
echo "üëâ Checking running processes..." | tee -a "$LOG_FILE"
ps -ef | grep "python3 -u" | grep -v grep | tee -a "$LOG_FILE"
echo | tee -a "$LOG_FILE"

echo "üëâ Health-checking server.py..." | tee -a "$LOG_FILE"
if pgrep -f "server.py" > /dev/null; then
  echo "‚úÖ server.py is running." | tee -a "$LOG_FILE"
else
  echo "‚ùå server.py is NOT running. Check $LOG_FILE for errors." | tee -a "$LOG_FILE"
fi

echo | tee -a "$LOG_FILE"
echo "==========================================================" | tee -a "$LOG_FILE"
echo "‚úÖ SAFE RESTART COMPLETE ‚Äî ALL COMPONENTS RUNNING" | tee -a "$LOG_FILE"
echo "Logs saved in: $LOG_FILE" | tee -a "$LOG_FILE"
echo "=========================================================="
