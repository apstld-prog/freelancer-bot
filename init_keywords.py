# init_keywords.py
# Ensures default keywords exist for the admin user (and fixes missing session import)

import os, sys
from sqlalchemy import text

sys.path.append(os.path.dirname(__file__))
from db import get_session  # ‚úÖ changed from "session" to "get_session"

DEFAULT_KEYWORDS = [
    "logo",
    "lighting",
    "dialux",
    "relux",
    "led",
    "œÜœâœÑŒπœÉŒºœåœÇ",
    "luminaire",
]

ADMIN_ID = 5254014824  # your Telegram admin user ID

def ensure_keywords():
    """Ensure default keywords exist for the admin user."""
    with get_session() as s:
        conn = s.connection()

        # ‚úÖ 1. Ensure admin user exists (if not, create)
        try:
            conn.execute(text("""
                INSERT INTO "user" (id, username, role, created_at)
                VALUES (:id, 'admin', 'admin', NOW() AT TIME ZONE 'UTC')
                ON CONFLICT (id) DO NOTHING;
            """), {"id": ADMIN_ID})
            s.commit()
            print(f"‚úÖ Admin user ensured in 'user' table.")
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not ensure admin user: {e}")

        # ‚úÖ 2. Fetch existing keywords
        try:
            rows = conn.execute(text("SELECT keyword FROM keyword WHERE user_id = :uid"), {"uid": ADMIN_ID}).fetchall()
            existing = [r[0] for r in rows]
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not fetch existing keywords ({e})")
            existing = []

        # ‚úÖ 3. Find missing ones
        missing = [k for k in DEFAULT_KEYWORDS if k not in existing]

        # ‚úÖ 4. Insert new keywords if needed
        if missing:
            print(f"üîÑ Inserting missing keywords for admin: {missing}")
            for kw in missing:
                try:
                    conn.execute(text("""
                        INSERT INTO keyword (user_id, keyword, value, created_at, updated_at)
                        VALUES (:uid, :kw, :kw, NOW() AT TIME ZONE 'UTC', NOW() AT TIME ZONE 'UTC')
                        ON CONFLICT DO NOTHING;
                    """), {"uid": ADMIN_ID, "kw": kw})
                except Exception as e:
                    print(f"‚ùå Failed to insert keyword '{kw}': {e}")
            s.commit()
            print("‚úÖ Default keywords inserted successfully.")
        else:
            print("‚úÖ All default keywords already exist for admin.")


if __name__ == "__main__":
    ensure_keywords()
